<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ - Admin & Signing Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 200px;
            background: linear-gradient(180deg, #3949ab 0%, #283593 100%);
            color: white;
            padding: 20px 0;
            z-index: 100;
        }
        
        .logo {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .menu-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .menu-item.active { background: #ff9800; border-left: 4px solid #f57c00; }
        
        /* Main Content */
        .main-content {
            margin-left: 200px;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 20px 40px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .content-area { padding: 30px 40px; }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3949ab;
            box-shadow: 0 0 0 3px rgba(57,73,171,0.1);
        }
        
        select.form-control {
            cursor: pointer;
            appearance: none;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E") no-repeat right 15px center;
            padding-right: 40px;
        }
        
        .form-group { margin-bottom: 20px; }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3949ab;
            color: white;
        }
        
        .btn-primary:hover {
            background: #303f9f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(57,73,171,0.4);
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
            width: 100%;
            padding: 16px;
            font-size: 16px;
        }
        
        .btn-success:hover { background: #45a049; }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #fafafa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        th {
            padding: 15px 20px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }
        
        td {
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        tbody tr:hover { background: #f8f9fa; }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-new { background: #e3f2fd; color: #1976d2; }
        .status-inprogress { background: #fff3e0; color: #f57c00; }
        .status-completed { background: #e8f5e9; color: #2e7d32; }
        
        /* Signing Page */
        .signing-container {
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .pdf-viewer {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .signature-pad {
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: crosshair;
            background: #fafafa;
            display: block;
            margin: 20px auto;
        }
        
        .workflow-status {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .status-step {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .status-step.completed {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        
        .status-step.current {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .status-step.pending {
            background: #fafafa;
            border-left: 4px solid #ddd;
        }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.show { display: block; }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .loading.show { display: block; }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3949ab;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .email-input-group {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            background: #4caf50;
            height: 100%;
            transition: width 0.3s;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .config-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            text-align: center;
        }

        .config-btn {
            background: rgba(255,255,255,0.3);
            border: 2px solid white;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 15px;
            font-size: 13px;
        }

        .config-btn:hover {
            background: white;
            color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Config Banner (Show only on admin page) -->
    <div id="configBanner" class="config-banner" style="display: none;">
        <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•: <span id="emailStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span></span>
        <button class="config-btn" onclick="openEmailSetup()">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ EmailJS</button>
    </div>

    <!-- ADMIN PAGE -->
    <div id="adminPage" class="page">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">üë§</div>
                <div style="font-size: 11px; line-height: 1.4; opacity: 0.9;">
                    <strong>Admin User</strong><br>
                    Document Admin
                </div>
            </div>
            <div class="menu-item active" onclick="showAdminTab('request')">
                <span>üìù</span> Request
            </div>
            <div class="menu-item" onclick="showAdminTab('myjobs')">
                <span>üìã</span> My Jobs
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Request Tab -->
            <div id="requestTab" class="admin-tab">
                <div class="header">
                    <h1 style="font-size: 18px; font-weight: 500;">Request - ‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h1>
                </div>

                <div class="content-area">
                    <div class="alert alert-success" id="successAlert"></div>
                    <div class="loading" id="loadingDiv">
                        <div class="spinner"></div>
                        <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•...</div>
                    </div>

                    <div class="card">
                        <h2 style="margin-bottom: 25px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h2>
                        
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select class="form-control" id="formType" onchange="updateFormType()">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≠‡∏£‡πå‡∏°</option>
                                <option value="form1">‡∏ü‡∏≠‡∏£‡πå‡∏° 1 - ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏õ‡∏¥‡∏î (1 ‡∏ú‡∏π‡πâ‡πÄ‡∏ã‡πá‡∏ô)</option>
                                <option value="form2">‡∏ü‡∏≠‡∏£‡πå‡∏° 2 - ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö (2 ‡∏ú‡∏π‡πâ‡πÄ‡∏ã‡πá‡∏ô)</option>
                                <option value="form3">‡∏ü‡∏≠‡∏£‡πå‡∏° 3 - ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (3 ‡∏ú‡∏π‡πâ‡πÄ‡∏ã‡πá‡∏ô)</option>
                            </select>
                        </div>

                        <div id="approverEmailsSection" style="display: none;">
                            <h3 style="margin: 25px 0 15px; font-size: 16px;">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Å‡∏£‡∏≠‡∏Å/‡∏ú‡∏π‡πâ‡πÄ‡∏ã‡πá‡∏ô</h3>
                            <div id="emailInputs"></div>
                        </div>

                        <div id="sendSection" style="display: none; margin-top: 30px;">
                            <button class="btn btn-success" onclick="sendDocument()" id="sendBtn">
                                üìß Send Document
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Jobs Tab -->
            <div id="myjobsTab" class="admin-tab" style="display: none;">
                <div class="header">
                    <h1 style="font-size: 18px; font-weight: 500;">My Jobs - ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h1>
                </div>

                <div class="content-area">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>REF.</th>
                                    <th>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                                    <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="jobsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIGNING PAGE -->
    <div id="signingPage" class="page">
        <div class="signing-container">
            <div class="workflow-status">
                <h2 style="margin-bottom: 20px;">üìÑ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h2>
                <div id="workflowStatus"></div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px;" id="signingTitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠</h2>
                
                <div class="alert alert-info show" id="signingInfo"></div>

                <!-- Form Fields -->
                <div id="formFieldsSection">
                    <h3 style="margin-bottom: 20px; font-size: 16px;">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• / Full Name</label>
                            <input type="text" class="form-control" id="fullName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô / Employee ID</label>
                            <input type="text" class="form-control" id="employeeId" placeholder="‡πÄ‡∏ä‡πà‡∏ô EMP001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">‡πÅ‡∏ú‡∏ô‡∏Å/‡∏ù‡πà‡∏≤‡∏¢ / Department</label>
                            <input type="text" class="form-control" id="department" placeholder="‡πÄ‡∏ä‡πà‡∏ô IT, HR">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date</label>
                            <input type="date" class="form-control" id="documentDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / Note (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <textarea class="form-control" id="note" rows="3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                    </div>
                </div>

                <!-- Signature -->
                <div style="margin: 30px 0;">
                    <h3 style="margin-bottom: 20px; font-size: 16px;">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                    <div style="text-align: center;">
                        <canvas id="signatureCanvas" class="signature-pad" width="600" height="200"></canvas>
                        <button class="btn" style="background: #999; color: white; margin-top: 15px;" onclick="clearSignature()">
                            üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                        </button>
                    </div>
                </div>

                <button class="btn btn-success" onclick="submitSignature()" id="submitBtn">
                    ‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
                </button>
            </div>
        </div>
    </div>

    <!-- Email Setup Modal -->
    <div class="modal" id="emailSetupModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ EmailJS</h2>
            
            <div class="alert alert-info show">
                <strong>üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:</strong><br>
                1. ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ü‡∏£‡∏µ‡∏ó‡∏µ‡πà <a href="https://www.emailjs.com" target="_blank">EmailJS.com</a><br>
                2. ‡πÄ‡∏û‡∏¥‡πà‡∏° Email Service (Gmail/Outlook)<br>
                3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Template<br>
                4. ‡∏ô‡∏≥ Keys ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
            </div>
            
            <div class="form-group">
                <label class="form-label">Public Key</label>
                <input type="text" class="form-control" id="publicKeyInput" placeholder="abcd1234efgh5678">
            </div>
            
            <div class="form-group">
                <label class="form-label">Service ID</label>
                <input type="text" class="form-control" id="serviceIdInput" placeholder="service_abc123">
            </div>
            
            <div class="form-group">
                <label class="form-label">Template ID</label>
                <input type="text" class="form-control" id="templateIdInput" placeholder="template_xyz789">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn" style="flex: 1; background: #999; color: white;" onclick="closeEmailSetup()">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button class="btn btn-primary" style="flex: 2;" onclick="saveEmailConfig()">
                    ‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
            </div>
        </div>
    </div>

    <script>
        const { PDFDocument, rgb, StandardFonts } = PDFLib;

        // Email Config
        let emailConfig = {
            publicKey: '',
            serviceId: '',
            templateId: ''
        };

        const formConfigs = {
            form1: {
                name: '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏õ‡∏¥‡∏î.pdf',
                approvers: [
                    { name: '‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£', role: '‡∏ú‡∏π‡πâ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£', email: '', needsFormFill: true, signPosition: { x: 350, y: 200 } }
                ]
            },
            form2: {
                name: '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö.pdf',
                approvers: [
                    { name: '‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£', role: '‡∏ú‡∏π‡πâ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£', email: '', needsFormFill: true, signPosition: { x: 350, y: 250 } },
                    { name: 'HR Department', role: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', email: '', needsFormFill: false, signPosition: { x: 350, y: 150 } }
                ]
            },
            form3: {
                name: '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤.pdf',
                approvers: [
                    { name: '‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£', role: '‡∏ú‡∏π‡πâ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£', email: '', needsFormFill: true, signPosition: { x: 350, y: 300 } },
                    { name: 'HR Department', role: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö 1', email: '', needsFormFill: false, signPosition: { x: 350, y: 200 } },
                    { name: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', role: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö 2', email: '', needsFormFill: false, signPosition: { x: 350, y: 100 } }
                ]
            }
        };

        let documents = [];
        let signaturePad = null;
        let currentDocument = null;
        let currentSignerIndex = null;

        // Initialize
        (function init() {
            loadEmailConfig();
            loadDocuments();
            checkPageType();
        })();

        function checkPageType() {
            const params = new URLSearchParams(window.location.search);
            const docId = params.get('doc');
            const signerIndex = params.get('signer');

            if (docId && signerIndex !== null) {
                // Signing page
                showSigningPage(docId, parseInt(signerIndex));
            } else {
                // Admin page
                showAdminPage();
            }
        }

        function showAdminPage() {
            document.getElementById('adminPage').classList.add('active');
            document.getElementById('signingPage').classList.remove('active');
            document.getElementById('configBanner').style.display = 'block';
            updateEmailStatus();
        }

        function showSigningPage(docId, signerIndex) {
            document.getElementById('adminPage').classList.remove('active');
            document.getElementById('signingPage').classList.add('active');
            document.getElementById('configBanner').style.display = 'none';
            
            loadSigningPage(docId, signerIndex);
        }

        function showAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));

            if (tab === 'request') {
                document.getElementById('requestTab').style.display = 'block';
                document.querySelectorAll('.menu-item')[0].classList.add('active');
            } else if (tab === 'myjobs') {
                document.getElementById('myjobsTab').style.display = 'block';
                document.querySelectorAll('.menu-item')[1].classList.add('active');
                renderJobsTable();
            }
        }

        // Email Config
        function loadEmailConfig() {
            try {
                const saved = localStorage.getItem('emailjs_config');
                if (saved) {
                    emailConfig = JSON.parse(saved);
                    if (emailConfig.publicKey) {
                        emailjs.init(emailConfig.publicKey);
                    }
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        function updateEmailStatus() {
            const status = document.getElementById('emailStatus');
            if (emailConfig.publicKey && emailConfig.serviceId && emailConfig.templateId) {
                status.textContent = '‚úì ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
                status.style.color = '#4caf50';
            } else {
                status.textContent = '‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤';
                status.style.color = '#ff9800';
            }
        }

        function openEmailSetup() {
            document.getElementById('emailSetupModal').classList.add('active');
            document.getElementById('publicKeyInput').value = emailConfig.publicKey || '';
            document.getElementById('serviceIdInput').value = emailConfig.serviceId || '';
            document.getElementById('templateIdInput').value = emailConfig.templateId || '';
        }

        function closeEmailSetup() {
            document.getElementById('emailSetupModal').classList.remove('active');
        }

        function saveEmailConfig() {
            const publicKey = document.getElementById('publicKeyInput').value.trim();
            const serviceId = document.getElementById('serviceIdInput').value.trim();
            const templateId = document.getElementById('templateIdInput').value.trim();
            
            if (!publicKey || !serviceId || !templateId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á');
                return;
            }
            
            emailConfig = { publicKey, serviceId, templateId };
            localStorage.setItem('emailjs_config', JSON.stringify(emailConfig));
            emailjs.init(publicKey);
            closeEmailSetup();
            updateEmailStatus();
            alert('‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }

        // Form Type Update
        function updateFormType() {
            const formType = document.getElementById('formType').value;
            
            if (!formType) {
                document.getElementById('approverEmailsSection').style.display = 'none';
                document.getElementById('sendSection').style.display = 'none';
                return;
            }

            const config = formConfigs[formType];
            
            document.getElementById('approverEmailsSection').style.display = 'block';
            document.getElementById('sendSection').style.display = 'block';

            const html = config.approvers.map((app, idx) => `
                <div class="email-input-group">
                    <div style="font-size: 14px; color: #666; font-weight: 500;">
                        ${idx + 1}. ${app.name}:
                    </div>
                    <input type="email" 
                           class="form-control approver-email" 
                           placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Gmail ‡∏´‡∏£‡∏∑‡∏≠ Outlook)" 
                           data-index="${idx}"
                           required>
                </div>
            `).join('');
            
            document.getElementById('emailInputs').innerHTML = html;
        }

        // Send Document
        async function sendDocument() {
            const formType = document.getElementById('formType').value;
            if (!formType) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≠‡∏£‡πå‡∏°');
                return;
            }

            if (!emailConfig.publicKey || !emailConfig.serviceId || !emailConfig.templateId) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ EmailJS ‡∏Å‡πà‡∏≠‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ EmailJS" ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)');
                return;
            }

            const emailInputs = document.querySelectorAll('.approver-email');
            const emails = Array.from(emailInputs).map(input => input.value.trim());
            
            if (emails.some(email => !email)) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô');
                return;
            }

            document.getElementById('loadingDiv').classList.add('show');

            try {
                const config = JSON.parse(JSON.stringify(formConfigs[formType]));
                const docId = 'DOC' + Date.now();
                
                config.approvers.forEach((app, idx) => {
                    app.email = emails[idx];
                    app.status = idx === 0 ? 'pending' : 'waiting';
                    app.signedAt = null;
                });

                const newDoc = {
                    id: docId,
                    type: formType,
                    name: config.name,
                    approvers: config.approvers,
                    currentStep: 0,
                    status: 'In Progress',
                    formData: null,
                    pdfData: null,
                    createdAt: new Date().toISOString()
                };

                documents.push(newDoc);
                await saveDocuments();

                // Send email to first approver
                const baseUrl = window.location.href.split('?')[0];
                const signingLink = `${baseUrl}?doc=${docId}&signer=0`;
                
                await sendEmail(emails[0], {
                    to_name: config.approvers[0].name,
                    document_name: config.name,
                    role: config.approvers[0].role,
                    signing_link: signingLink
                });

                document.getElementById('loadingDiv').classList.remove('show');
                
                const alert = document.getElementById('successAlert');
                alert.textContent = `‚úì ‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${emails[0]} ‡πÅ‡∏•‡πâ‡∏ß`;
                alert.classList.add('show');
                
                setTimeout(() => {
                    alert.classList.remove('show');
                    resetForm();
                    showAdminTab('myjobs');
                }, 3000);

            } catch (error) {
                document.getElementById('loadingDiv').classList.remove('show');
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                console.error(error);
            }
        }

        async function sendEmail(to, params) {
            try {
                const response = await emailjs.send(
                    emailConfig.serviceId,
                    emailConfig.templateId,
                    {
                        to_email: to,
                        to_name: params.to_name,
                        document_name: params.document_name,
                        role: params.role,
                        signing_link: params.signing_link,
                        from_name: '‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'
                    }
                );
                return response;
            } catch (error) {
                console.error('Email error:', error);
                throw error;
            }
        }

        function resetForm() {
            document.getElementById('formType').value = '';
            updateFormType();
        }

        // Jobs Table
        function renderJobsTable() {
            const tbody = document.getElementById('jobsTableBody');
            
            if (documents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = documents.map(doc => {
                const progress = Math.round((doc.currentStep / doc.approvers.length) * 100);
                const statusClass = doc.status === 'Completed' ? 'status-completed' : 
                                  doc.status === 'In Progress' ? 'status-inprogress' : 'status-new';
                
                return `
                    <tr>
                        <td><strong>${doc.id}</strong></td>
                        <td>${doc.name}</td>
                        <td>${new Date(doc.createdAt).toLocaleString('th-TH', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <small style="color: #666;">${doc.currentStep} / ${doc.approvers.length} ‡∏Ñ‡∏ô</small>
                        </td>
                        <td><span class="status-badge ${statusClass}">${doc.status}</span></td>
                        <td>
                            ${doc.status === 'Completed' && doc.pdfData ? 
                                `<button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="downloadPDF('${doc.id}')">
                                    üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                                </button>` :
                                `<button class="btn" style="padding: 8px 16px; font-size: 13px; background: #999; color: white;" onclick="viewStatus('${doc.id}')">
                                    üëÅÔ∏è ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                                </button>`
                            }
                        </td>
                    </tr>
                `;
            }).reverse().join('');
        }

        function viewStatus(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc) return;

            let statusText = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ã‡πá‡∏ô:\n\n';
            doc.approvers.forEach((app, idx) => {
                const icon = app.status === 'signed' ? '‚úì' : 
                            app.status === 'pending' ? '‚Üí' : '‚óã';
                statusText += `${icon} ${idx + 1}. ${app.name} (${app.role})\n`;
                if (app.status === 'signed') {
                    statusText += `   ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(app.signedAt).toLocaleString('th-TH')}\n`;
                } else if (app.status === 'pending') {
                    statusText += `   ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ã‡πá‡∏ô\n`;
                } else {
                    statusText += `   ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ã‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤\n`;
                }
                statusText += '\n';
            });

            alert(statusText);
        }

        function downloadPDF(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc || !doc.pdfData) return;

            try {
                const bytes = Uint8Array.from(atob(doc.pdfData), c => c.charCodeAt(0));
                const blob = new Blob([bytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = doc.name;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
                console.error(error);
            }
        }

        // Signing Page
        function loadSigningPage(docId, signerIndex) {
            const doc = documents.find(d => d.id === docId);
            
            if (!doc) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
                return;
            }

            const approver = doc.approvers[signerIndex];
            
            if (approver.status === 'signed') {
                alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }

            if (approver.status === 'waiting') {
                alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            currentDocument = doc;
            currentSignerIndex = signerIndex;

            // Setup page
            document.getElementById('signingTitle').textContent = `${approver.name} - ${approver.role}`;
            document.getElementById('signingInfo').innerHTML = `
                ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ${approver.needsFormFill ? '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞' : ''}‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "<strong>${doc.name}</strong>"
            `;

            // Show/hide form fields
            document.getElementById('formFieldsSection').style.display = 
                approver.needsFormFill ? 'block' : 'none';

            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('documentDate').value = today;

            // Show workflow
            showWorkflowStatus(doc, signerIndex);

            // Init signature pad
            setTimeout(() => {
                const canvas = document.getElementById('signatureCanvas');
                signaturePad = new SignaturePad(canvas);
            }, 100);
        }

        function showWorkflowStatus(doc, currentIndex) {
            const html = doc.approvers.map((app, idx) => `
                <div class="status-step ${app.status === 'signed' ? 'completed' : idx === currentIndex ? 'current' : 'pending'}">
                    <div style="font-weight: bold; margin-right: 10px;">${idx + 1}.</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${app.name}</div>
                        <div style="font-size: 12px; color: #666;">${app.role}</div>
                    </div>
                    <div style="font-size: 12px; font-weight: 500;">
                        ${app.status === 'signed' ? '‚úì ‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : 
                          idx === currentIndex ? '‚Üí ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏∏‡∏ì' : '‚óã ‡∏£‡∏≠'}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('workflowStatus').innerHTML = html;
        }

        // Signature Pad Class
        class SignaturePad {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.isDrawing = false;
                
                this.canvas.addEventListener('mousedown', this.startDrawing.bind(this));
                this.canvas.addEventListener('mousemove', this.draw.bind(this));
                this.canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                this.canvas.addEventListener('touchstart', this.handleTouch.bind(this));
                this.canvas.addEventListener('touchmove', this.handleTouch.bind(this));
                this.canvas.addEventListener('touchend', this.stopDrawing.bind(this));
            }

            startDrawing(e) {
                this.isDrawing = true;
                [this.lastX, this.lastY] = [e.offsetX, e.offsetY];
            }

            draw(e) {
                if (!this.isDrawing) return;
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(e.offsetX, e.offsetY);
                this.ctx.strokeStyle = '#000';
                this.ctx.lineWidth = 2;
                this.ctx.lineCap = 'round';
                this.ctx.stroke();
                [this.lastX, this.lastY] = [e.offsetX, e.offsetY];
            }

            handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = this.canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                if (e.type === 'touchstart') {
                    this.isDrawing = true;
                    [this.lastX, this.lastY] = [x, y];
                } else if (this.isDrawing) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.lastX, this.lastY);
                    this.ctx.lineTo(x, y);
                    this.ctx.strokeStyle = '#000';
                    this.ctx.lineWidth = 2;
                    this.ctx.lineCap = 'round';
                    this.ctx.stroke();
                    [this.lastX, this.lastY] = [x, y];
                }
            }

            stopDrawing() {
                this.isDrawing = false;
            }

            clear() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            getDataURL() {
                return this.canvas.toDataURL('image/png');
            }

            isEmpty() {
                const blank = document.createElement('canvas');
                blank.width = this.canvas.width;
                blank.height = this.canvas.height;
                return this.canvas.toDataURL() === blank.toDataURL();
            }
        }

        function clearSignature() {
            if (signaturePad) {
                signaturePad.clear();
            }
        }

        // Submit Signature
        async function submitSignature() {
            if (!signaturePad || signaturePad.isEmpty()) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô');
                return;
            }

            const approver = currentDocument.approvers[currentSignerIndex];
            
            // Get form data (if needed)
            let formData = null;
            if (approver.needsFormFill) {
                const fullName = document.getElementById('fullName').value.trim();
                if (!fullName) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•');
                    return;
                }
                
                formData = {
                    fullName,
                    employeeId: document.getElementById('employeeId').value,
                    department: document.getElementById('department').value,
                    date: document.getElementById('documentDate').value,
                    note: document.getElementById('note').value
                };
            }

            const signature = signaturePad.getDataURL();

            // Update document
            approver.signature = signature;
            approver.status = 'signed';
            approver.signedAt = new Date().toISOString();

            if (formData) {
                currentDocument.formData = formData;
            }

            // Create/Update PDF
            if (!currentDocument.pdfData) {
                currentDocument.pdfData = await createInitialPDF(currentDocument);
            }
            
            currentDocument.pdfData = await addSignatureToPDF(
                currentDocument.pdfData,
                signature,
                currentSignerIndex,
                currentDocument,
                formData
            );

            // Move to next step or complete
            if (currentSignerIndex < currentDocument.approvers.length - 1) {
                currentDocument.currentStep++;
                currentDocument.approvers[currentSignerIndex + 1].status = 'pending';
                
                // Send email to next approver
                const nextApprover = currentDocument.approvers[currentSignerIndex + 1];
                const baseUrl = window.location.href.split('?')[0];
                const signingLink = `${baseUrl}?doc=${currentDocument.id}&signer=${currentSignerIndex + 1}`;
                
                try {
                    await sendEmail(nextApprover.email, {
                        to_name: nextApprover.name,
                        document_name: currentDocument.name,
                        role: nextApprover.role,
                        signing_link: signingLink
                    });
                    
                    alert('‚úì ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
                } catch (error) {
                    alert('‚úì ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n(‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ EmailJS)');
                }
            } else {
                // Completed
                currentDocument.status = 'Completed';
                currentDocument.currentStep = currentDocument.approvers.length;
                alert('‚úì ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß!\n\n‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ My Jobs');
            }

            await saveDocuments();
            
            // Redirect to thank you
            setTimeout(() => {
                alert('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ');
            }, 1000);
        }

        async function createInitialPDF(doc) {
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage([595, 842]);
            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const { width, height } = page.getSize();

            // Header
            page.drawRectangle({
                x: 0,
                y: height - 80,
                width: width,
                height: 80,
                color: rgb(0.22, 0.29, 0.67)
            });

            page.drawText(doc.name, {
                x: 50,
                y: height - 45,
                size: 18,
                font,
                color: rgb(1, 1, 1)
            });

            // Form data (if exists)
            if (doc.formData) {
                let yPos = height - 130;
                const fields = [
                    { label: 'Full Name:', value: doc.formData.fullName },
                    { label: 'Employee ID:', value: doc.formData.employeeId },
                    { label: 'Department:', value: doc.formData.department },
                    { label: 'Date:', value: doc.formData.date },
                    { label: 'Note:', value: doc.formData.note || '-' }
                ];

                fields.forEach(field => {
                    page.drawText(`${field.label} ${field.value}`, {
                        x: 50,
                        y: yPos,
                        size: 12,
                        font,
                        color: rgb(0, 0, 0)
                    });
                    yPos -= 25;
                });
            }

            // Signature areas
            let yPos = 300;
            doc.approvers.forEach((app, idx) => {
                page.drawRectangle({
                    x: 40,
                    y: yPos - 70,
                    width: 515,
                    height: 75,
                    borderColor: rgb(0.7, 0.7, 0.7),
                    borderWidth: 1
                });

                page.drawText(`${idx + 1}. ${app.name} (${app.role})`, {
                    x: 50,
                    y: yPos - 25,
                    size: 11,
                    font,
                    color: rgb(0, 0, 0)
                });

                page.drawLine({
                    start: { x: 350, y: yPos - 35 },
                    end: { x: 530, y: yPos - 35 },
                    thickness: 1,
                    color: rgb(0, 0, 0)
                });

                yPos -= 90;
            });

            const bytes = await pdfDoc.save();
            return btoa(String.fromCharCode.apply(null, bytes));
        }

        async function addSignatureToPDF(pdfData, signatureDataUrl, signerIndex, doc, formData) {
            const bytes = Uint8Array.from(atob(pdfData), c => c.charCodeAt(0));
            const pdfDoc = await PDFDocument.load(bytes);
            const pages = pdfDoc.getPages();
            const firstPage = pages[0];

            const approver = doc.approvers[signerIndex];
            const signPos = approver.signPosition;

            const pngImage = await pdfDoc.embedPng(signatureDataUrl);
            const signatureDims = pngImage.scale(0.3);

            firstPage.drawImage(pngImage, {
                x: signPos.x,
                y: signPos.y,
                width: signatureDims.width,
                height: signatureDims.height
            });

            const name = formData ? formData.fullName : approver.name;
            const now = new Date().toLocaleString('th-TH');
            
            firstPage.drawText(name, {
                x: signPos.x,
                y: signPos.y - 15,
                size: 8,
                color: rgb(0.4, 0.4, 0.4)
            });

            firstPage.drawText(`Date: ${now}`, {
                x: signPos.x,
                y: signPos.y - 25,
                size: 7,
                color: rgb(0.5, 0.5, 0.5)
            });

            const newBytes = await pdfDoc.save();
            return btoa(String.fromCharCode.apply(null, newBytes));
        }

        // Storage
        async function saveDocuments() {
            try {
                localStorage.setItem('signing_documents', JSON.stringify(documents));
            } catch (error) {
                console.error('Save error:', error);
            }
        }

        async function loadDocuments() {
            try {
                const saved = localStorage.getItem('signing_documents');
                if (saved) {
                    documents = JSON.parse(saved);
                }
            } catch (error) {
                documents = [];
            }
        }
    </script>
</body>
</html>
