<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ - Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 200px;
            background: linear-gradient(180deg, #3949ab 0%, #283593 100%);
            color: white;
            padding: 20px 0;
            z-index: 100;
        }
        
        .logo {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .menu-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .menu-item.active { background: #ff9800; border-left: 4px solid #f57c00; }
        
        .main-content {
            margin-left: 200px;
            min-height: 100vh;
        }
        
        .config-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            text-align: center;
        }

        .config-btn {
            background: rgba(255,255,255,0.3);
            border: 2px solid white;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 15px;
            font-size: 13px;
        }

        .config-btn:hover {
            background: white;
            color: #667eea;
        }
        
        .header {
            background: white;
            padding: 20px 40px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .content-area { padding: 30px 40px; }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3949ab;
            box-shadow: 0 0 0 3px rgba(57,73,171,0.1);
        }
        
        select.form-control {
            cursor: pointer;
            appearance: none;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E") no-repeat right 15px center;
            padding-right: 40px;
        }
        
        .form-group { margin-bottom: 20px; }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3949ab;
            color: white;
        }
        
        .btn-primary:hover {
            background: #303f9f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(57,73,171,0.4);
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
            width: 100%;
            padding: 16px;
            font-size: 16px;
        }
        
        .btn-success:hover { background: #45a049; }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .email-input-group {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.show { display: block; }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .loading.show { display: block; }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3949ab;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #fafafa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        th {
            padding: 15px 20px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }
        
        td {
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        tbody tr:hover { background: #f8f9fa; }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-inprogress { background: #fff3e0; color: #f57c00; }
        .status-completed { background: #e8f5e9; color: #2e7d32; }
        
        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            background: #4caf50;
            height: 100%;
            transition: width 0.3s;
        }

        .page { display: none; }
        .page.active { display: block; }

        .signing-container {
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        
        #signatureCanvas {
            border: 3px solid #3949ab;
            border-radius: 8px;
            cursor: crosshair;
            background: white;
            display: block;
            margin: 20px auto;
            touch-action: none;
        }
        
        .workflow-status {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .status-step {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .status-step.completed {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        
        .status-step.current {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .status-step.pending {
            background: #fafafa;
            border-left: 4px solid #ddd;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #3949ab;
            font-size: 13px;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <!-- Config Banner -->
    <div id="configBanner" class="config-banner">
        <span>Google Apps Script: <span id="scriptStatus">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span></span>
        <button class="config-btn" onclick="openScriptSetup()">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Script URL</button>
    </div>

    <!-- ADMIN PAGE -->
    <div id="adminPage" class="page active">
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">üë§</div>
                <div style="font-size: 11px; line-height: 1.4; opacity: 0.9;">
                    <strong>Admin User</strong><br>
                    Document Admin
                </div>
            </div>
            <div class="menu-item active" onclick="showAdminTab('request')">
                <span>üìù</span> Request
            </div>
            <div class="menu-item" onclick="showAdminTab('myjobs')">
                <span>üìã</span> My Jobs
            </div>
        </div>

        <div class="main-content">
            <!-- Request Tab -->
            <div id="requestTab" class="admin-tab">
                <div class="header">
                    <h1 style="font-size: 18px; font-weight: 500;">Request - ‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h1>
                </div>

                <div class="content-area">
                    <div class="alert alert-success" id="successAlert"></div>
                    <div class="alert alert-error" id="errorAlert"></div>
                    <div class="loading" id="loadingDiv">
                        <div class="spinner"></div>
                        <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•...</div>
                    </div>

                    <div class="card">
                        <h2 style="margin-bottom: 25px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h2>
                        
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select class="form-control" id="formType" onchange="updateFormType()">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≠‡∏£‡πå‡∏°</option>
                                <option value="form1">Form 1 - Contract (1 person)</option>
                                <option value="form2">Form 2 - NDA (2 people)</option>
                                <option value="form3">Form 3 - Agreement (3 people)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Admin Email (‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à)</label>
                            <input type="email" class="form-control" id="adminEmail" placeholder="your-email@gmail.com">
                        </div>

                        <div id="approverEmailsSection" style="display: none;">
                            <h3 style="margin: 25px 0 15px; font-size: 16px;">Signer Emails</h3>
                            <div id="emailInputs"></div>
                        </div>

                        <div id="sendSection" style="display: none; margin-top: 30px;">
                            <button class="btn btn-success" onclick="sendDocument()" id="sendBtn">
                                üìß Send Document
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Jobs Tab -->
            <div id="myjobsTab" class="admin-tab" style="display: none;">
                <div class="header">
                    <h1 style="font-size: 18px; font-weight: 500;">My Jobs - Track Status</h1>
                </div>

                <div class="content-area">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>REF.</th>
                                    <th>Document</th>
                                    <th>Created</th>
                                    <th>Progress</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="jobsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                        No documents yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIGNING PAGE -->
    <div id="signingPage" class="page">
        <div class="signing-container">
            <div class="workflow-status">
                <h2 style="margin-bottom: 20px;">üìÑ Document Approval Status</h2>
                <div id="workflowStatus"></div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px;" id="signingTitle">Please fill in and sign</h2>
                
                <div class="alert alert-warning show" style="display: block;">
                    <strong>üìå Note:</strong> Signature is <strong>OPTIONAL</strong>. You can submit without signing.
                </div>

                <div class="info-box" id="signingInfo"></div>

                <div id="formFieldsSection">
                    <h3 style="margin-bottom: 20px; font-size: 16px;">Fill Information</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="fullName" placeholder="e.g. John Doe">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Employee ID</label>
                            <input type="text" class="form-control" id="employeeId" placeholder="e.g. EMP001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-control" id="department" placeholder="e.g. IT, HR">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="documentDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Note (optional)</label>
                        <textarea class="form-control" id="note" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                </div>

                <div style="margin: 30px 0;">
                    <h3 style="margin-bottom: 10px; font-size: 16px;">Your Signature (Optional)</h3>
                    <p style="color: #666; font-size: 13px; margin-bottom: 20px;">Draw your signature below, or skip to use your name as signature</p>
                    <div style="text-align: center;">
                        <canvas id="signatureCanvas" width="600" height="200"></canvas>
                        <button class="btn" style="background: #999; color: white; margin-top: 15px;" onclick="clearSignature()">
                            üóëÔ∏è Clear Signature
                        </button>
                    </div>
                </div>

                <button class="btn btn-success" onclick="submitSignature()" id="submitBtn">
                    ‚úì Submit Document
                </button>
            </div>
        </div>
    </div>

    <!-- Script Setup Modal -->
    <div class="modal" id="scriptSetupModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è Setup Google Apps Script</h2>
            
            <div class="alert" style="display: block; background: #fff3cd; color: #856404; border-left: 4px solid #ffc107;">
                <strong>üìñ How to setup:</strong><br>
                1. Create Google Apps Script<br>
                2. Deploy as Web app<br>
                3. Paste URL below
            </div>
            
            <div class="form-group">
                <label class="form-label">Apps Script URL</label>
                <input type="text" class="form-control" id="scriptUrlInput" 
                       placeholder="https://script.google.com/macros/s/.../exec">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn" style="flex: 1; background: #999; color: white;" onclick="closeScriptSetup()">
                    Cancel
                </button>
                <button class="btn btn-primary" style="flex: 2;" onclick="saveScriptConfig()">
                    ‚úì Save
                </button>
            </div>
        </div>
    </div>

    <script>
        const { PDFDocument, rgb, StandardFonts } = PDFLib;

        let scriptConfig = { url: 'https://script.google.com/macros/s/AKfycbyPMloEDGi9GvR1Zle_YKyg88rrsza9xEqccAr8SUCMxEncfT9oRvFJpFDrVsbvjng4nw/exec' };
        const formConfigs = {
            form1: {
                name: 'Contract.pdf',
                approvers: [
                    { name: 'Applicant', role: 'Signer', email: '', needsFormFill: true, signPosition: { x: 350, y: 200 } }
                ]
            },
            form2: {
                name: 'NDA.pdf',
                approvers: [
                    { name: 'Applicant', role: 'Signer', email: '', needsFormFill: true, signPosition: { x: 350, y: 250 } },
                    { name: 'HR', role: 'Approver', email: '', needsFormFill: false, signPosition: { x: 350, y: 150 } }
                ]
            },
            form3: {
                name: 'Agreement.pdf',
                approvers: [
                    { name: 'Applicant', role: 'Signer', email: '', needsFormFill: true, signPosition: { x: 350, y: 300 } },
                    { name: 'HR', role: 'Approver 1', email: '', needsFormFill: false, signPosition: { x: 350, y: 200 } },
                    { name: 'Manager', role: 'Approver 2', email: '', needsFormFill: false, signPosition: { x: 350, y: 100 } }
                ]
            }
        };

        let documents = [];
        let canvas, ctx;
        let isDrawing = false;
        let currentDocument = null;
        let currentSignerIndex = null;

        (function init() {
            loadScriptConfig();
            loadDocuments();
            checkPageType();
        })();

        function checkPageType() {
            const params = new URLSearchParams(window.location.search);
            const docId = params.get('doc');
            const signerIndex = params.get('signer');

            if (docId && signerIndex !== null) {
                showSigningPage(docId, parseInt(signerIndex));
            } else {
                showAdminPage();
            }
        }

        function showAdminPage() {
            document.getElementById('adminPage').classList.add('active');
            document.getElementById('signingPage').classList.remove('active');
            document.getElementById('configBanner').style.display = 'block';
            updateScriptStatus();
        }

        function showSigningPage(docId, signerIndex) {
            document.getElementById('adminPage').classList.remove('active');
            document.getElementById('signingPage').classList.add('active');
            document.getElementById('configBanner').style.display = 'none';
            
            loadSigningPage(docId, signerIndex);
        }

        function showAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));

            if (tab === 'request') {
                document.getElementById('requestTab').style.display = 'block';
                document.querySelectorAll('.menu-item')[0].classList.add('active');
            } else if (tab === 'myjobs') {
                document.getElementById('myjobsTab').style.display = 'block';
                document.querySelectorAll('.menu-item')[1].classList.add('active');
                renderJobsTable();
            }
        }

        function loadScriptConfig() {
            try {
                const saved = localStorage.getItem('script_config');
                if (saved) {
                    const savedConfig = JSON.parse(saved);
                    if (savedConfig.url) {
                        scriptConfig = savedConfig;
                    }
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        function updateScriptStatus() {
            const status = document.getElementById('scriptStatus');
            if (scriptConfig.url) {
                status.textContent = '‚úì Ready';
                status.style.color = '#4caf50';
            } else {
                status.textContent = '‚ö†Ô∏è Not configured';
                status.style.color = '#ff9800';
            }
        }

        function openScriptSetup() {
            document.getElementById('scriptSetupModal').classList.add('active');
            document.getElementById('scriptUrlInput').value = scriptConfig.url || '';
        }

        function closeScriptSetup() {
            document.getElementById('scriptSetupModal').classList.remove('active');
        }

        function saveScriptConfig() {
            const url = document.getElementById('scriptUrlInput').value.trim();
            
            if (!url) {
                alert('Please enter URL');
                return;
            }

            if (!url.includes('script.google.com')) {
                alert('Invalid URL');
                return;
            }
            
            scriptConfig.url = url;
            localStorage.setItem('script_config', JSON.stringify(scriptConfig));
            closeScriptSetup();
            updateScriptStatus();
            alert('‚úì Configuration saved!');
        }

        function updateFormType() {
            const formType = document.getElementById('formType').value;
            
            if (!formType) {
                document.getElementById('approverEmailsSection').style.display = 'none';
                document.getElementById('sendSection').style.display = 'none';
                return;
            }

            const config = formConfigs[formType];
            
            document.getElementById('approverEmailsSection').style.display = 'block';
            document.getElementById('sendSection').style.display = 'block';

            const html = config.approvers.map((app, idx) => `
                <div class="email-input-group">
                    <div style="font-size: 14px; color: #666; font-weight: 500;">
                        ${idx + 1}. ${app.name}:
                    </div>
                    <input type="email" 
                           class="form-control approver-email" 
                           placeholder="Email (Gmail or Outlook)" 
                           data-index="${idx}"
                           required>
                </div>
            `).join('');
            
            document.getElementById('emailInputs').innerHTML = html;
        }

        async function sendDocument() {
            const formType = document.getElementById('formType').value;
            const adminEmail = document.getElementById('adminEmail').value.trim();
            
            if (!formType) {
                showError('Please select form type');
                return;
            }

            if (!adminEmail) {
                showError('Please enter your email');
                return;
            }

            if (!scriptConfig.url) {
                showError('‚ö†Ô∏è Please configure Google Apps Script URL');
                return;
            }

            const emailInputs = document.querySelectorAll('.approver-email');
            const emails = Array.from(emailInputs).map(input => input.value.trim());
            
            if (emails.some(email => !email)) {
                showError('Please enter all emails');
                return;
            }

            document.getElementById('loadingDiv').classList.add('show');

            try {
                const config = JSON.parse(JSON.stringify(formConfigs[formType]));
                const docId = 'DOC' + Date.now();
                
                config.approvers.forEach((app, idx) => {
                    app.email = emails[idx];
                    app.status = idx === 0 ? 'pending' : 'waiting';
                    app.signedAt = null;
                });

                const newDoc = {
                    id: docId,
                    type: formType,
                    name: config.name,
                    approvers: config.approvers,
                    adminEmail: adminEmail,
                    currentStep: 0,
                    status: 'In Progress',
                    formData: null,
                    pdfData: null,
                    createdAt: new Date().toISOString()
                };

                documents.push(newDoc);
                await saveDocuments();

                const baseUrl = window.location.href.split('?')[0];
                const signingLink = `${baseUrl}?doc=${docId}&signer=0`;
                
                await sendEmailViaScript(emails[0], {
                    toName: config.approvers[0].name,
                    documentName: config.name,
                    role: config.approvers[0].role,
                    signingLink: signingLink
                });

                document.getElementById('loadingDiv').classList.remove('show');
                showSuccess(`‚úì Document sent! Email sent to ${emails[0]}`);
                
                setTimeout(() => {
                    resetForm();
                    showAdminTab('myjobs');
                }, 3000);

            } catch (error) {
                document.getElementById('loadingDiv').classList.remove('show');
                showError('Error: ' + error.message);
                console.error(error);
            }
        }

        async function sendEmailViaScript(toEmail, params) {
            try {
                const response = await fetch(scriptConfig.url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        toEmail: toEmail,
                        toName: params.toName,
                        documentName: params.documentName,
                        role: params.role,
                        signingLink: params.signingLink
                    })
                });

                console.log('Email sent via Google Apps Script');
                return { success: true };
                
            } catch (error) {
                console.error('Email error:', error);
                throw new Error('Cannot send email');
            }
        }

        function resetForm() {
            document.getElementById('formType').value = '';
            document.getElementById('adminEmail').value = '';
            updateFormType();
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        function renderJobsTable() {
            const tbody = document.getElementById('jobsTableBody');
            
            if (documents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                            No documents yet
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = documents.map(doc => {
                const progress = Math.round((doc.currentStep / doc.approvers.length) * 100);
                const statusClass = doc.status === 'Completed' ? 'status-completed' : 'status-inprogress';
                
                return `
                    <tr>
                        <td><strong>${doc.id}</strong></td>
                        <td>${doc.name}</td>
                        <td>${new Date(doc.createdAt).toLocaleString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <small style="color: #666;">${doc.currentStep} / ${doc.approvers.length} people</small>
                        </td>
                        <td><span class="status-badge ${statusClass}">${doc.status}</span></td>
                        <td>
                            ${doc.status === 'Completed' && doc.pdfData ? 
                                `<button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="downloadPDF('${doc.id}')">
                                    üì• Download
                                </button>` :
                                `<button class="btn" style="padding: 8px 16px; font-size: 13px; background: #999; color: white;" onclick="viewStatus('${doc.id}')">
                                    üëÅÔ∏è View Status
                                </button>`
                            }
                        </td>
                    </tr>
                `;
            }).reverse().join('');
        }

        function viewStatus(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc) return;

            let statusText = 'Signing Status:\n\n';
            doc.approvers.forEach((app, idx) => {
                const icon = app.status === 'signed' ? '‚úì' : 
                            app.status === 'pending' ? '‚Üí' : '‚óã';
                statusText += `${icon} ${idx + 1}. ${app.name} (${app.role})\n`;
                if (app.status === 'signed') {
                    statusText += `   Signed: ${new Date(app.signedAt).toLocaleString()}\n`;
                } else if (app.status === 'pending') {
                    statusText += `   ‚Üí Waiting for signature\n`;
                } else {
                    statusText += `   Waiting for previous signer\n`;
                }
                statusText += '\n';
            });

            alert(statusText);
        }

        function downloadPDF(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc || !doc.pdfData) return;

            try {
                const bytes = Uint8Array.from(atob(doc.pdfData), c => c.charCodeAt(0));
                const blob = new Blob([bytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = doc.name;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Download error');
                console.error(error);
            }
        }

        function loadSigningPage(docId, signerIndex) {
            const doc = documents.find(d => d.id === docId);
            
            if (!doc) {
                alert('Document not found');
                return;
            }

            const approver = doc.approvers[signerIndex];
            
            if (approver.status === 'signed') {
                alert('You have already signed this document');
                return;
            }

            if (approver.status === 'waiting') {
                alert('Not your turn yet. Please wait for previous signer.');
                return;
            }

            currentDocument = doc;
            currentSignerIndex = signerIndex;

            document.getElementById('signingTitle').textContent = `${approver.name} - ${approver.role}`;
            document.getElementById('signingInfo').innerHTML = `
                You are assigned to ${approver.needsFormFill ? 'fill and ' : ''}sign document "<strong>${doc.name}</strong>"
            `;

            document.getElementById('formFieldsSection').style.display = 
                approver.needsFormFill ? 'block' : 'none';

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('documentDate').value = today;

            showWorkflowStatus(doc, signerIndex);
            initCanvas();
        }
        
        function initCanvas() {
            canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            
            canvas.onmousedown = startDrawing;
            canvas.onmousemove = draw;
            canvas.onmouseup = stopDrawing;
            canvas.onmouseleave = stopDrawing;
            
            canvas.ontouchstart = handleTouchStart;
            canvas.ontouchmove = handleTouchMove;
            canvas.ontouchend = stopDrawing;
            
            console.log('Canvas initialized');
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function handleTouchStart(e) {
            e.preventDefault();
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            ctx.beginPath();
            ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        }

        function handleTouchMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearSignature() {
            if (ctx && canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function isCanvasBlank() {
            if (!canvas || !ctx) return true;
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i + 3] > 0) return false;
            }
            return true;
        }

        function showWorkflowStatus(doc, currentIndex) {
            const html = doc.approvers.map((app, idx) => `
                <div class="status-step ${app.status === 'signed' ? 'completed' : idx === currentIndex ? 'current' : 'pending'}">
                    <div style="font-weight: bold; margin-right: 10px;">${idx + 1}.</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${app.name}</div>
                        <div style="font-size: 12px; color: #666;">${app.role}</div>
                    </div>
                    <div style="font-size: 12px; font-weight: 500;">
                        ${app.status === 'signed' ? '‚úì Signed' : 
                          idx === currentIndex ? '‚Üí Your turn' : '‚óã Waiting'}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('workflowStatus').innerHTML = html;
        }

        async function submitSignature() {
            console.log('=== SUBMIT STARTED ===');
            
            try {
                const approver = currentDocument.approvers[currentSignerIndex];
                
                // Validate form
                let formData = null;
                if (approver.needsFormFill) {
                    const fullName = document.getElementById('fullName').value.trim();
                    if (!fullName) {
                        alert('Please enter full name');
                        console.log('ERROR: Full name empty');
                        return;
                    }
                    
                    formData = {
                        fullName,
                        employeeId: document.getElementById('employeeId').value,
                        department: document.getElementById('department').value,
                        date: document.getElementById('documentDate').value,
                        note: document.getElementById('note').value
                    };
                    console.log('Form data OK:', formData);
                }

                // Get signature (optional)
                let signature = null;
                if (!isCanvasBlank()) {
                    signature = canvas.toDataURL('image/png');
                    console.log('Signature captured from canvas');
                } else {
                    signature = await createTextSignature(formData ? formData.fullName : approver.name);
                    console.log('Using text signature');
                }

                // Disable button
                document.getElementById('submitBtn').disabled = true;
                console.log('Processing...');

                approver.signature = signature;
                approver.status = 'signed';
                approver.signedAt = new Date().toISOString();

                if (formData) {
                    currentDocument.formData = formData;
                }

                if (!currentDocument.pdfData) {
                    currentDocument.pdfData = await createInitialPDF(currentDocument);
                    console.log('PDF created');
                }
                
                currentDocument.pdfData = await addSignatureToPDF(
                    currentDocument.pdfData,
                    signature,
                    currentSignerIndex,
                    currentDocument,
                    formData
                );
                console.log('Signature added to PDF');

                if (currentSignerIndex < currentDocument.approvers.length - 1) {
                    currentDocument.currentStep++;
                    currentDocument.approvers[currentSignerIndex + 1].status = 'pending';
                    
                    const nextApprover = currentDocument.approvers[currentSignerIndex + 1];
                    const baseUrl = window.location.href.split('?')[0];
                    const signingLink = `${baseUrl}?doc=${currentDocument.id}&signer=${currentSignerIndex + 1}`;
                    
                    try {
                        await sendEmailViaScript(nextApprover.email, {
                            toName: nextApprover.name,
                            documentName: currentDocument.name,
                            role: nextApprover.role,
                            signingLink: signingLink
                        });
                        console.log('Email sent to next approver');
                        alert('‚úì Signed successfully! Email sent to next approver.');
                    } catch (error) {
                        console.error('Email error:', error);
                        alert('‚úì Signed successfully!\n(Note: Email sending failed)');
                    }
                } else {
                    currentDocument.status = 'Completed';
                    currentDocument.currentStep = currentDocument.approvers.length;
                    
                    try {
                        await sendCompletionEmail(currentDocument);
                        console.log('Completion email sent');
                    } catch (error) {
                        console.error('Completion email error:', error);
                    }
                    
                    alert('‚úì Document completed!\n\nAdmin can download PDF from My Jobs page.');
                }

                await saveDocuments();
                console.log('=== SUBMIT COMPLETED ===');
                
                setTimeout(() => {
                    alert('Thank you for signing. You can close this page.');
                }, 1000);

            } catch (error) {
                console.error('SUBMIT ERROR:', error);
                alert('Error: ' + error.message);
                document.getElementById('submitBtn').disabled = false;
            }
        }

        async function createTextSignature(name) {
            const textCanvas = document.createElement('canvas');
            textCanvas.width = 300;
            textCanvas.height = 100;
            const textCtx = textCanvas.getContext('2d');
            
            textCtx.fillStyle = 'white';
            textCtx.fillRect(0, 0, textCanvas.width, textCanvas.height);
            
            textCtx.font = 'italic 24px Arial';
            textCtx.fillStyle = 'black';
            textCtx.fillText(name, 20, 60);
            
            return textCanvas.toDataURL('image/png');
        }

        async function sendCompletionEmail(doc) {
            if (!doc.adminEmail) return;
            
            const baseUrl = window.location.href.split('?')[0];
            
            try {
                await fetch(scriptConfig.url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        emailType: 'completion',
                        toEmail: doc.adminEmail,
                        toName: 'Admin',
                        documentName: doc.name,
                        docId: doc.id,
                        downloadLink: baseUrl,
                        signers: doc.approvers.map(a => ({
                            name: a.name,
                            role: a.role,
                            signedAt: a.signedAt
                        }))
                    })
                });
            } catch (error) {
                console.error('Completion email error:', error);
            }
        }

        async function createInitialPDF(doc) {
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage([595, 842]);
            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const { width, height } = page.getSize();

            page.drawRectangle({
                x: 0,
                y: height - 80,
                width: width,
                height: 80,
                color: rgb(0.22, 0.29, 0.67)
            });

            page.drawText(doc.name, {
                x: 50,
                y: height - 45,
                size: 18,
                font,
                color: rgb(1, 1, 1)
            });

            if (doc.formData) {
                let yPos = height - 130;
                const fields = [
                    { label: 'Full Name:', value: doc.formData.fullName },
                    { label: 'Employee ID:', value: doc.formData.employeeId },
                    { label: 'Department:', value: doc.formData.department },
                    { label: 'Date:', value: doc.formData.date },
                    { label: 'Note:', value: doc.formData.note || '-' }
                ];

                fields.forEach(field => {
                    page.drawText(`${field.label} ${field.value}`, {
                        x: 50,
                        y: yPos,
                        size: 12,
                        font,
                        color: rgb(0, 0, 0)
                    });
                    yPos -= 25;
                });
            }

            let yPos = 300;
            doc.approvers.forEach((app, idx) => {
                page.drawRectangle({
                    x: 40,
                    y: yPos - 70,
                    width: 515,
                    height: 75,
                    borderColor: rgb(0.7, 0.7, 0.7),
                    borderWidth: 1
                });

                page.drawText(`${idx + 1}. ${app.name} (${app.role})`, {
                    x: 50,
                    y: yPos - 25,
                    size: 11,
                    font,
                    color: rgb(0, 0, 0)
                });

                page.drawLine({
                    start: { x: 350, y: yPos - 35 },
                    end: { x: 530, y: yPos - 35 },
                    thickness: 1,
                    color: rgb(0, 0, 0)
                });

                yPos -= 90;
            });

            const bytes = await pdfDoc.save();
            return btoa(String.fromCharCode.apply(null, bytes));
        }

        async function addSignatureToPDF(pdfData, signatureDataUrl, signerIndex, doc, formData) {
            const bytes = Uint8Array.from(atob(pdfData), c => c.charCodeAt(0));
            const pdfDoc = await PDFDocument.load(bytes);
            const pages = pdfDoc.getPages();
            const firstPage = pages[0];

            const approver = doc.approvers[signerIndex];
            const signPos = approver.signPosition;

            const pngImage = await pdfDoc.embedPng(signatureDataUrl);
            const signatureDims = pngImage.scale(0.3);

            firstPage.drawImage(pngImage, {
                x: signPos.x,
                y: signPos.y,
                width: signatureDims.width,
                height: signatureDims.height
            });

            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const name = formData ? formData.fullName : approver.name;
            const now = new Date().toLocaleString('en-US');
            
            firstPage.drawText(name, {
                x: signPos.x,
                y: signPos.y - 15,
                size: 8,
                font,
                color: rgb(0.4, 0.4, 0.4)
            });

            firstPage.drawText(`Date: ${now}`, {
                x: signPos.x,
                y: signPos.y - 25,
                size: 7,
                font,
                color: rgb(0.5, 0.5, 0.5)
            });

            const newBytes = await pdfDoc.save();
            return btoa(String.fromCharCode.apply(null, newBytes));
        }

        async function saveDocuments() {
            try {
                localStorage.setItem('signing_documents', JSON.stringify(documents));
            } catch (error) {
                console.error('Save error:', error);
            }
        }

        async function loadDocuments() {
            try {
                const saved = localStorage.getItem('signing_documents');
                if (saved) {
                    documents = JSON.parse(saved);
                }
            } catch (error) {
                documents = [];
            }
        }
    </script>
</body>
</html>
